<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>–†–æ–±–∏–Ω–∑–æ–Ω ‚Äî –∏–≥—Ä–∞</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#05010a" />
  <style>
    *{box-sizing:border-box;margin:0;padding:0}

    html,body{
      width:100%;height:100%;overflow:hidden;
      font-family:system-ui,-apple-system,BlinkMacSystemFont,sans-serif;
      background:
        radial-gradient(circle at top,#2b0b18 0,#05010a 40%,#020008 100%);
      color:#fff;
    }

    /* ---------- TOP UI (Pulz style) ---------- */
    #ui{
      position:absolute;top:0;left:0;right:0;
      padding:8px 10px 4px;
      display:flex;flex-direction:column;gap:4px;
      background:linear-gradient(
        to bottom,
        rgba(5,0,15,.92),
        rgba(5,0,15,.6),
        rgba(5,0,15,0)
      );
      /* –∫—Ä–∞—Å–Ω—É—é –ø–æ–ª–æ—Å–∫—É —É–±—Ä–∞–ª–∏ ‚Äî –≥—Ä–∞–Ω–∏—Ü—ã –±–æ–ª—å—à–µ –Ω–µ—Ç */
      box-shadow:0 6px 18px rgba(0,0,0,.7);
      z-index:10;pointer-events:none;
    }
    #ui-top{
      display:flex;align-items:center;justify-content:space-between;
      gap:10px;pointer-events:auto;
    }
    #logo{
      width:220px;height:55px;
      background:url('assets/logo_robinson.png') no-repeat left center/contain;
      text-indent:-9999px;overflow:hidden;flex-shrink:0;
      filter:drop-shadow(0 0 8px rgba(255,24,78,.75));
    }

    button{
      border:none;border-radius:999px;padding:6px 12px;
      font-size:14px;font-weight:600;cursor:pointer;
      background:linear-gradient(135deg,#ff184e,#ff4b2b);
      color:#ffffff;
      border:1px solid rgba(255,255,255,.14);
      box-shadow:
        0 0 12px rgba(255,24,78,.7),
        0 4px 14px rgba(0,0,0,.7);
      white-space:nowrap;
      text-shadow:0 1px 2px rgba(0,0,0,.8);
      transition:transform .08s ease,box-shadow .08s ease,filter .12s ease;
    }
    button:active{
      transform:scale(.95) translateY(1px);
      box-shadow:
        0 0 6px rgba(255,24,78,.6),
        0 2px 8px rgba(0,0,0,.8);
    }
    button:disabled{
      opacity:.4;cursor:default;
      box-shadow:none;
      filter:grayscale(.8) brightness(.7);
    }

    #auth-panel{
      display:flex;gap:6px;justify-content:flex-end;
      pointer-events:auto;padding:0 2px;flex-shrink:0;
    }
    #menu-btn{
      width:60px;height:60px;padding:0;border-radius:50%;
      background:url('assets/btn_menu.png') center no-repeat;
      background-size:100% 100%;
      box-shadow:
        0 0 10px rgba(255,24,78,.75),
        0 4px 12px rgba(0,0,0,.8);
      font-size:0;
    }
    #menu-btn:active{
      transform:scale(.94) translateY(1px);
    }

    #stats{
      display:none;justify-content:space-between;font-size:14px;
      text-shadow:0 1px 3px rgba(0,0,0,.7);padding:0 2px;
    }
    #status-text{
      display:none;font-weight:600;
      color:#ff8aa8;
      text-shadow:0 1px 3px rgba(0,0,0,.9);
    }

    /* ---------- CANVAS + DIM ---------- */
    #canvas-container{
      position:absolute;
      inset:0;
    }
    #canvas-container::before{
      content:"";
      position:absolute;
      inset:0;
      background:radial-gradient(circle at top,rgba(0,0,0,.05),rgba(0,0,0,.35));
      pointer-events:none;
      z-index:1;
    }
    canvas{
      width:100%;
      height:100%;
      display:block;
    }

    /* ---------- SPLASH (start screen) ---------- */
    #splash{
      position:fixed;inset:0;
      background:
        radial-gradient(circle at top,#3a0d1f 0,#05010a 45%,#010006 100%),
        #000;
      display:flex;align-items:center;justify-content:center;
      z-index:999;transition:opacity .6s ease;
    }
    #splash.hidden{opacity:0;pointer-events:none}
    #splash-inner{
      width:100%;max-width:360px;
      padding:24px 20px calc(24px + env(safe-area-inset-bottom));
      text-align:center;display:flex;flex-direction:column;gap:16px;
      color:#fff;text-shadow:0 2px 6px rgba(0,0,0,.9);
      background:radial-gradient(circle at top,#1a0710,#05010a);
      border-radius:20px;
      border:1px solid rgba(255,24,78,.35);
      box-shadow:
        0 0 22px rgba(255,24,78,.6),
        0 18px 40px rgba(0,0,0,.9);
    }
    #splash-logo{
      font-size:26px;font-weight:800;letter-spacing:1.5px;
      text-transform:uppercase;
    }
    #splash-logo span{
      font-size:30px;margin-right:6px;
      filter:drop-shadow(0 0 10px rgba(255,200,120,.9));
    }
    #splash-subtitle{
      font-size:14px;opacity:.9;
      color:#ffe1f0;
    }
    #splash-hint{
      font-size:12px;opacity:.75;
      color:#ffadc9;
    }

    /* ---------- BOTTOM UI (Pulz panel) ---------- */
    #bottom-ui{
      position:absolute;left:0;right:0;bottom:0;
      min-height:120px;
      background:linear-gradient(
        to top,
        rgba(5,0,15,.96),
        rgba(5,0,15,.9),
        rgba(5,0,15,.7)
      );
      display:none;
      align-items:center;justify-content:space-around;
      padding:8px 10px calc(8px + env(safe-area-inset-bottom,0px));
      z-index:2000;pointer-events:auto;
      backdrop-filter:blur(16px);
      border-top:1px solid rgba(255,24,78,.6);
      box-shadow:0 -10px 30px rgba(0,0,0,.95);
    }
    #bottom-ui,#bottom-ui *{
      color:#ffffff;
    }
    .bottom-item{
      font-size:16px;text-shadow:0 2px 4px rgba(0,0,0,.7);
      display:flex;flex-direction:column;gap:2px;pointer-events:auto;
    }
    .bottom-label{
      font-size:11px;text-transform:uppercase;
      opacity:.7;letter-spacing:.08em;
      color:#ff7ea2;
    }
    .bottom-value{
      font-size:18px;font-weight:700;
      color:#ffffff;
    }
    #bottom-bet,#auto-toggle{cursor:pointer}

    /* ---------- PLAY BUTTON (Pulz glow) ---------- */
    #start-round-btn{
      width:128px;height:128px;padding:0;border-radius:50%;
      background:url('assets/btn_play.png') center no-repeat;
      background-size:100% 100%;
      box-shadow:
        0 0 30px rgba(255,24,78,.9),
        0 0 60px rgba(255,24,78,.7),
        0 6px 20px rgba(0,0,0,1);
      font-size:0;
      position:relative;
      z-index:2;
      overflow:visible;
    }
    #start-round-btn::after{
      content:"";
      position:absolute;inset:-14px;
      border-radius:50%;
      border:2px solid rgba(255,24,78,.75);
      box-shadow:
        0 0 18px rgba(255,24,78,.9),
        0 0 32px rgba(255,24,78,.7);
      opacity:.85;
      animation:pulsePlay 1.4s infinite ease-in-out;
    }
    #start-round-btn:disabled::after{
      opacity:0;
      animation:none;
    }
    @keyframes pulsePlay{
      0%{transform:scale(1);opacity:.8;}
      50%{transform:scale(1.08);opacity:.35;}
      100%{transform:scale(1);opacity:.8;}
    }

    /* ---------- MENU PANEL ---------- */
    #menu-panel{
      position:absolute;top:52px;right:10px;
      background:radial-gradient(circle at top,#1a0710,#05010a);
      border-radius:16px;
      padding:12px;display:none;flex-direction:column;gap:8px;
      z-index:2100;min-width:190px;
      backdrop-filter:blur(14px);
      border:1px solid rgba(255,24,78,.45);
      box-shadow:
        0 0 22px rgba(255,24,78,.7),
        0 18px 38px rgba(0,0,0,.95);
    }
    #menu-panel.open{display:flex}
    .menu-item{
      width:180px;height:48px;padding:0;border-radius:999px;
      background-position:center;background-repeat:no-repeat;
      background-size:100% 100%;box-shadow:none;font-size:0;
      background-color:transparent;
    }
    #menu-deposit{background-image:url('assets/btn_deposit.png')}
    #menu-withdraw{background-image:url('assets/btn_withdraw.png')}
  </style>
</head>
<body>
  <!-- –ó–∞—Å—Ç–∞–≤–∫–∞ -->
  <div id="splash">
    <div id="splash-inner">
      <div id="splash-logo"><span>üèùÔ∏è</span></div>
      <div id="splash-subtitle">
        –õ–µ—Ç–∏ –∫ –æ—Å—Ç—Ä–æ–≤—É, —Å–æ–±–∏—Ä–∞–π –±–æ–Ω—É—Å—ã –∏ —É–º–Ω–æ–∂–∞–π –≤—ã–∏–≥—Ä—ã—à.
      </div>
      <div id="splash-hint">
        –°–æ–≤–µ—Ç: –≤—ã–±–µ—Ä–∏ —Å—Ç–∞–≤–∫—É (–≤–Ω–∏–∑—É —Å–ø—Ä–∞–≤–∞), –∞ –∑–∞—Ç–µ–º –∂–º–∏ ‚ñ∂.
      </div>
    </div>
  </div>

  <!-- –í–µ—Ä—Ö–Ω–∏–π UI -->
  <div id="ui">
    <div id="ui-top">
      <div id="logo">–†–æ–±–∏–Ω–∑–æ–Ω</div>
      <div id="auth-panel">
        <button id="menu-btn" aria-label="–ú–µ–Ω—é"></button>
      </div>
    </div>
    <div id="stats">
      <div>–ú–Ω–æ–∂–∏—Ç–µ–ª—å: <span id="multiplier">1.00x</span></div>
      <div id="balance-box">–ë–∞–ª–∞–Ω—Å: <span id="balance">0.00</span> ü™ô</div>
    </div>
    <div id="status-text">–°–¥–µ–ª–∞–π —Å—Ç–∞–≤–∫—É –∏ –Ω–∞–∂–º–∏ ‚ñ∂</div>
  </div>

  <!-- –ú–µ–Ω—é -->
  <div id="menu-panel">
    <button class="menu-item" id="menu-deposit">Deposit</button>
    <button class="menu-item" id="menu-withdraw">Withdraw</button>
  </div>

  <!-- –ù–∏–∂–Ω–µ–µ —Ç–∞–±–ª–æ -->
  <div id="bottom-ui">
    <div class="bottom-item" id="bottom-balance">
      <div class="bottom-label">Balance</div>
      <div class="bottom-value" id="balance-bottom">0.00</div>
    </div>
    <button id="start-round-btn">‚ñ∂</button>
    <div class="bottom-item" id="bottom-bet">
      <div class="bottom-label">Bet</div>
      <div class="bottom-value" id="bet-bottom">1.00</div>
    </div>
    <div class="bottom-item" id="auto-toggle">
      <div class="bottom-label">Auto</div>
      <div class="bottom-value" id="auto-status">Off</div>
    </div>
  </div>

  <div id="canvas-container">
    <canvas id="game"></canvas>
  </div>

  <script>
    const canvas=document.getElementById("game");
    const ctx=canvas.getContext("2d");

    const multiplierEl=document.getElementById("multiplier");
    const statusEl=document.getElementById("status-text");
    const startBtn=document.getElementById("start-round-btn");
    const balanceEl=document.getElementById("balance");
    const balanceBottomEl=document.getElementById("balance-bottom");
    const betBottomEl=document.getElementById("bet-bottom");

    const autoToggleEl=document.getElementById("auto-toggle");
    const autoStatusEl=document.getElementById("auto-status");

    const splash=document.getElementById("splash");
    const bottomUi=document.getElementById("bottom-ui");

    const menuBtn=document.getElementById("menu-btn");
    const menuPanel=document.getElementById("menu-panel");
    const menuDepositBtn=document.getElementById("menu-deposit");
    const menuWithdrawBtn=document.getElementById("menu-withdraw");

    // —Å–∫—Ä—ã–≤–∞–µ–º –∑–∞—Å—Ç–∞–≤–∫—É —á–µ—Ä–µ–∑ 4 —Å–µ–∫ –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω–∏–∂–Ω–µ–µ –º–µ–Ω—é
    setTimeout(()=>{
      if(splash && !splash.classList.contains("hidden")){
        splash.classList.add("hidden");
      }
      if(bottomUi){
        bottomUi.style.display="flex";
      }
    },4000);

    function resizeCanvas(){
      const rect=canvas.getBoundingClientRect();
      canvas.width=rect.width*window.devicePixelRatio;
      canvas.height=rect.height*window.devicePixelRatio;
      ctx.setTransform(window.devicePixelRatio,0,0,window.devicePixelRatio,0,0);
    }
    window.addEventListener("resize",resizeCanvas);
    resizeCanvas();

    function loadImage(src){
      return new Promise((res,rej)=>{
        const img=new Image();
        img.src=src;
        img.onload=()=>res(img);
        img.onerror=rej;
      });
    }

    const assets={};
    const ASSET_LIST={
      bg:"assets/bg_ocean.png",
      rob:"assets/robinson.png",
      island:"assets/island_long.png",
      bird:"assets/bird_spritesheet.png",
      x2:"assets/bonus_x2.png",
      x3:"assets/bonus_x3.png",
      x5:"assets/bonus_x5.png",
      x10:"assets/bonus_x10.png",
      x20:"assets/bonus_x20.png",
      x50:"assets/bonus_x50.png",
      x100:"assets/bonus_x100.png",
      gameover:"assets/game_over.png",
      win:"assets/win.png"
    };

    let allLoaded=false;
    (async function preload(){
      for(const [key,src] of Object.entries(ASSET_LIST)){
        assets[key]=await loadImage(src).catch(()=>null);
      }
      allLoaded=true;
      statusEl.textContent="–ì–æ—Ç–æ–≤–æ –∫ –∏–≥—Ä–µ";
      initProfile();
    })();

    // -------- Web Audio –∑–≤—É–∫–∏ --------
    let audioCtx=null;
    function getAudioCtx(){
      if(!audioCtx){
        const AC=window.AudioContext||window.webkitAudioContext;
        if(!AC) return null;
        audioCtx=new AC();
      }
      if(audioCtx.state==="suspended") audioCtx.resume();
      return audioCtx;
    }
    function playTone(freq=440,dur=.2,type="sine",vol=.4){
      const ac=getAudioCtx(); if(!ac) return;
      const osc=ac.createOscillator();
      const g=ac.createGain();
      osc.type=type;
      osc.frequency.value=freq;
      g.gain.value=vol;
      osc.connect(g);g.connect(ac.destination);
      const now=ac.currentTime;
      g.gain.setValueAtTime(0,now);
      g.gain.linearRampToValueAtTime(vol,now+0.01);
      g.gain.linearRampToValueAtTime(0.0001,now+dur);
      osc.start(now);osc.stop(now+dur+0.02);
    }
    function playChirp(f1,f2,dur,vol=.5){
      const ac=getAudioCtx(); if(!ac) return;
      const osc=ac.createOscillator();
      const g=ac.createGain();
      osc.type="sine";
      osc.frequency.setValueAtTime(f1,ac.currentTime);
      osc.frequency.linearRampToValueAtTime(f2,ac.currentTime+dur);
      g.gain.value=vol;
      osc.connect(g);g.connect(ac.destination);
      const now=ac.currentTime;
      g.gain.setValueAtTime(0,now);
      g.gain.linearRampToValueAtTime(vol,now+0.01);
      g.gain.linearRampToValueAtTime(0.0001,now+dur);
      osc.start(now);osc.stop(now+dur+0.02);
    }
    function playNoiseBurst(dur=.25,vol=.35){
      const ac=getAudioCtx(); if(!ac) return;
      const len=Math.floor(ac.sampleRate*dur);
      const buf=ac.createBuffer(1,len,ac.sampleRate);
      const data=buf.getChannelData(0);
      for(let i=0;i<len;i++) data[i]=(Math.random()*2-1)*0.9;
      const src=ac.createBufferSource();
      const g=ac.createGain();
      src.buffer=buf;src.connect(g);g.connect(ac.destination);
      const now=ac.currentTime;
      g.gain.setValueAtTime(0,now);
      g.gain.linearRampToValueAtTime(vol,now+0.02);
      g.gain.linearRampToValueAtTime(0.0001,now+dur);
      src.start(now);src.stop(now+dur+0.05);
    }
    function playWinSound(){
      playTone(880,0.18,"triangle",0.4);
      setTimeout(()=>playTone(1175,0.2,"triangle",0.45),120);
      setTimeout(()=>playTone(1320,0.25,"triangle",0.4),220);
    }
    function playBonusSound(){playChirp(700,1100,0.18,0.5);}
    function playBirdSound(){playChirp(400,200,0.15,0.45);}
    function playSplashSound(){playNoiseBurst(0.3,0.35);}
    // -----------------------------

    let state="idle"; // idle | flying | won | lost
    let robinson;
    let objects;
    let time;
    let lastTs;
    let multiplier;
    let baseBet=1;
    let userBalance=100;

    const HERO_X_REL=0.25;
    const OBJECT_SPEED = 494;
    const ISLAND_BASE_PROB=0.012;

    const BIRD_BASE_PROB  = 0.14 * 3;
    const BONUS_BASE_PROB = 0.14 * 3;

    const WATER_LINE_REL=0.8;
    const GRAVITY_BASE=75;
    let gravity=GRAVITY_BASE;

    let bonusPulse=0;
    let robinsonAnimTime=0;
    let cameraY=0,cameraLockY=null;

    let splashParticles=[];
    let hasSplashed=false;
    let heroVisible=true;

    let gameOverAnimTime=0,winAnimTime=0;
    let bonusParticles=[];
    let shakeTime=0;

    const VIEW_OFFSET_REL=0.10;

    // RTP
    let totalBet=0,totalPayout=0;
    const TARGET_RTP=0.96;
    let roundHistory=[];

    let autoPlay=false,autoRestartTimer=0;

    // –≤—Å–ø–ª—ã–≤–∞—é—â–∏–µ –Ω–∞–¥–ø–∏—Å–∏ –±–æ–Ω—É—Å–æ–≤
    let floatingTexts = [];

    function getCurrentRTP(){
      if(totalBet<=0) return TARGET_RTP;
      return totalPayout/totalBet;
    }
    function getRTPFactor(){
      if(totalBet<50) return 1;
      const current=getCurrentRTP();
      const diff=TARGET_RTP-current;
      let factor=1+diff*0.7;
      if(factor<0.5) factor=0.5;
      if(factor>1.6) factor=1.6;
      return factor;
    }
    function updateHistoryUI(){return;}

    function resetRound(){
      const w=canvas.width/window.devicePixelRatio;
      const h=canvas.height/window.devicePixelRatio;
      robinson={x:w*HERO_X_REL,y:h*0.5,vy:-170,width:65,height:65};
      gravity=GRAVITY_BASE;
      objects=[];
      splashParticles=[];
      hasSplashed=false;
      heroVisible=true;
      time=0;
      multiplier=1;
      lastTs=performance.now();
      bonusPulse=0;
      robinsonAnimTime=0;
      cameraY=0;cameraLockY=null;
      gameOverAnimTime=0;winAnimTime=0;
      autoRestartTimer=0;shakeTime=0;
      floatingTexts = [];
      multiplierEl.textContent="1.00x";

      const baseX=w*0.55;
      const spacing=150;
      const startBonuses=["x2","x3","x5","x2","x10","x3"];
      const bonusSize=38;
      startBonuses.forEach((kind,i)=>{
        const yOffset=(Math.random()*0.12-0.06)*h;
        objects.push({
          type:"bonus",
          kind,
          x:baseX+i*spacing,
          y:robinson.y+yOffset,
          w:bonusSize,h:bonusSize,
          phase:Math.random()*Math.PI*2
        });
      });
    }

    function initProfile(){
      userBalance=100;
      updateBalanceUI();
      statusEl.textContent="–î–µ–º–æ-—Ä–µ–∂–∏–º: —É —Ç–µ–±—è 100 –º–æ–Ω–µ—Ç";
      betBottomEl.textContent=baseBet.toFixed(2);
      updateHistoryUI();
    }
    function updateBalanceUI(){
      balanceEl.textContent=userBalance.toFixed(2);
      balanceBottomEl.textContent=userBalance.toFixed(2);
    }

    // –ú–µ–Ω—é
    menuBtn.addEventListener("click",e=>{
      e.stopPropagation();
      menuPanel.classList.toggle("open");
    });
    document.addEventListener("click",e=>{
      if(!menuPanel.contains(e.target)&&e.target!==menuBtn){
        // –ø—Ä–∏ –∂–µ–ª–∞–Ω–∏–∏ –º–æ–∂–Ω–æ –∑–∞–∫—Ä—ã–≤–∞—Ç—å –º–µ–Ω—é
      }
    });
    menuDepositBtn.addEventListener("click",()=>{
      const amountStr=prompt("–ü–æ–ø–æ–ª–Ω–∏—Ç—å –±–∞–ª–∞–Ω—Å (–º–æ–Ω–µ—Ç—ã):");
      const amount=parseFloat(amountStr||"0");
      if(!amount||amount<=0) return;
      userBalance+=amount;
      updateBalanceUI();
      statusEl.textContent="–ë–∞–ª–∞–Ω—Å –ø–æ–ø–æ–ª–Ω–µ–Ω";
    });
    menuWithdrawBtn.addEventListener("click",()=>{
      const amountStr=prompt("–í—ã–≤–µ—Å—Ç–∏ –±–∞–ª–∞–Ω—Å (–º–æ–Ω–µ—Ç—ã):");
      const amount=parseFloat(amountStr||"0");
      if(!amount||amount<=0) return;
      if(amount>userBalance){
        alert("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤ –¥–ª—è –≤—ã–≤–æ–¥–∞");
        return;
      }
      userBalance-=amount;
      updateBalanceUI();
      statusEl.textContent="–ë–∞–ª–∞–Ω—Å –≤—ã–≤–µ–¥–µ–Ω";
    });

    document.getElementById("bottom-bet").addEventListener("click",()=>{
      const vStr=prompt("–í–≤–µ–¥–∏—Ç–µ —Å—Ç–∞–≤–∫—É",baseBet.toFixed(2));
      const val=parseFloat(vStr||"");
      if(!val||val<=0) return;
      baseBet=val;
      betBottomEl.textContent=baseBet.toFixed(2);
    });
    autoToggleEl.addEventListener("click",()=>{
      autoPlay=!autoPlay;
      autoStatusEl.textContent=autoPlay?"On":"Off";
    });

    function startRound(){
      if(!allLoaded) return;
      if(userBalance<baseBet){
        statusEl.textContent="–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –º–æ–Ω–µ—Ç. –ü–æ–ø–æ–ª–Ω–∏ –±–∞–ª–∞–Ω—Å.";
        return;
      }
      getAudioCtx();
      totalBet+=baseBet;
      userBalance-=baseBet;
      updateBalanceUI();
      resetRound();
      state="flying";
      statusEl.textContent="–†–æ–±–∏–Ω–∑–æ–Ω –≤ –ø–æ–ª—ë—Ç–µ...";
      startBtn.disabled=true;
    }
    startBtn.addEventListener("click",()=>{
      if(state==="idle"||state==="won"||state==="lost") startRound();
    });

    function finishRound(result){
      let winAmount=0;
      if(result==="won"){
        winAmount=baseBet*multiplier;
        userBalance+=winAmount;
        totalPayout+=winAmount;
        updateBalanceUI();
      }
      roundHistory.unshift({result,bet:baseBet,multiplier,win:winAmount});
      if(roundHistory.length>50) roundHistory.pop();
      updateHistoryUI();
      startBtn.disabled=false;

      const rtp=getCurrentRTP()*100;
      console.log(`RTP: ${rtp.toFixed(1)}% (target ${(TARGET_RTP*100).toFixed(0)}%)`);
    }

    function getLastOfType(type){
      for(let i=objects.length-1;i>=0;i--){
        if(objects[i].type===type) return objects[i];
      }
      return null;
    }

    function spawnIsland(){
      const w=canvas.width/window.devicePixelRatio;
      const h=canvas.height/window.devicePixelRatio;
      const width=260,height=80;
      const y=h*WATER_LINE_REL;
      const x=w+width*0.6;
      const last=getLastOfType("island");
      const minGap=260;
      if(last && last.x-x<minGap) return;
      objects.push({type:"island",x,y,w:width,h:height});
    }

    function spawnBird(){
      const w=canvas.width/window.devicePixelRatio;
      const h=canvas.height/window.devicePixelRatio;
      const size=58;
      const minY=h*0.05;
      const maxY=h*0.78;
      const y=minY+Math.random()*(maxY-minY);
      const x=w+size*0.8;
      const last=getLastOfType("bird");
      const minGap=80;
      if(last && last.x-x<minGap) return;
      objects.push({
        type:"bird",
        x,y,w:size,h:size,
        phase:Math.random()*Math.PI*2
      });
    }

    const BONUS_WEIGHTS=[
      {key:"x2",w:40},
      {key:"x3",w:30},
      {key:"x5",w:15},
      {key:"x10",w:8},
      {key:"x20",w:4},
      {key:"x50",w:2},
      {key:"x100",w:1},
    ];
    function randomBonusKey(rtpFactor){
      const factor=rtpFactor||1;
      const ws=BONUS_WEIGHTS.map(b=>({...b}));

      for(const b of ws){
        if(["x10","x20","x50","x100"].includes(b.key)){
          b.w*=factor;
        }else{
          b.w*=(2-factor);
        }
      }

      let total=0;for(const b of ws) total+=b.w;
      let r=Math.random()*total;
      for(const b of ws){
        if(r<b.w) return b.key;
        r-=b.w;
      }
      return "x2";
    }
    function spawnBonus(rtpFactor){
      const w=canvas.width/window.devicePixelRatio;
      const h=canvas.height/window.devicePixelRatio;
      const size=38;
      const minY=h*0.08;
      const maxY=h*0.75;
      const y=minY+Math.random()*(maxY-minY);
      const x=w+size*0.6;
      const last=getLastOfType("bonus");
      const minGap=100;
      if(last && last.x-x<minGap) return;
      objects.push({
        type:"bonus",
        kind:randomBonusKey(rtpFactor),
        x,y,w:size,h:size,
        phase:Math.random()*Math.PI*2
      });
    }

    function isColliding(a,b){
      return !(a.x+a.w<b.x || a.x>b.x+b.w || a.y+a.h<b.y || a.y>b.y+b.h);
    }
    function createSplash(x,waterY){
      const count=22;
      for(let i=0;i<count;i++){
        const angle=Math.random()*Math.PI-Math.PI/2;
        const speed=180+Math.random()*140;
        splashParticles.push({
          x,
          y:waterY,
          vx:Math.cos(angle)*speed,
          vy:Math.sin(angle)*speed*0.8,
          life:0,
          maxLife:0.7+Math.random()*0.3,
          r:2+Math.random()*3
        });
      }
    }
    function addBonusParticles(x,y){
      const count=18;
      for(let i=0;i<count;i++){
        const ang=Math.random()*Math.PI*2;
        const sp=60+Math.random()*70;
        bonusParticles.push({
          x,y,
          vx:Math.cos(ang)*sp,
          vy:Math.sin(ang)*sp,
          life:0,
          maxLife:0.5+Math.random()*0.2
        });
      }
    }
    function vibrate(pattern){
      if(navigator.vibrate) navigator.vibrate(pattern);
    }

    function spawnFloatingText(text,x,y){
      floatingTexts.push({
        text,
        x,
        y,
        life:0,
        maxLife:1.0,
        vx:0,
        vy:-40,
        alpha:1
      });
    }

    function update(dt){
      time+=dt;
      bonusPulse=Math.max(0,bonusPulse-dt);
      robinsonAnimTime+=dt;
      if(shakeTime>0) shakeTime=Math.max(0,shakeTime-dt);

      const w=canvas.width/window.devicePixelRatio;
      const h=canvas.height/window.devicePixelRatio;
      const waterY=h*WATER_LINE_REL;

      // —á–∞—Å—Ç–∏—Ü—ã –≤–æ–¥—ã
      for(const p of splashParticles){
        p.x+=p.vx*dt;
        p.y+=p.vy*dt;
        p.vy+=350*dt;
        p.life+=dt;
      }
      splashParticles=splashParticles.filter(p=>p.life<p.maxLife);

      // —á–∞—Å—Ç–∏—Ü—ã –±–æ–Ω—É—Å–∞
      for(const p of bonusParticles){
        p.x+=p.vx*dt;
        p.y+=p.vy*dt;
        p.vx*=0.98;p.vy*=0.98;
        p.life+=dt;
      }
      bonusParticles=bonusParticles.filter(p=>p.life<p.maxLife);

      // –≤—Å–ø–ª—ã–≤–∞—é—â–∏–µ –Ω–∞–¥–ø–∏—Å–∏
      for(const ft of floatingTexts){
        ft.life+=dt;
        ft.y+=ft.vy*dt;
        ft.alpha=1-ft.life/ft.maxLife;
      }
      floatingTexts=floatingTexts.filter(ft=>ft.life<ft.maxLife);

      if((state==="won"||state==="lost") && autoPlay){
        autoRestartTimer+=dt;
        if(autoRestartTimer>1.5 && !startBtn.disabled && userBalance>=baseBet){
          autoRestartTimer=0;startRound();return;
        }
      }

      if(state==="idle"||state==="won"){
        cameraY=-(robinson.y-h*0.55)*0.3;
        cameraLockY=null;
        if(state==="won") winAnimTime+=dt;
        return;
      }

      if(state==="lost"){
        if(cameraLockY===null) cameraLockY=cameraY;
        cameraY=cameraLockY;
        gameOverAnimTime+=dt;
        return;
      }

      // FLYING
      robinson.vy+=gravity*dt;
      robinson.y+=robinson.vy*dt;

      const topLimit=h*0.05;
      if(robinson.y<topLimit){
        robinson.y=topLimit;
        if(robinson.vy<0) robinson.vy=0;
      }

      // –≤–æ–¥–∞ = –ø—Ä–æ–∏–≥—Ä—ã—à
      if(robinson.y+robinson.height/2>=waterY){
        state="lost";
        statusEl.textContent="–†–æ–±–∏–Ω–∑–æ–Ω —É–ø–∞–ª –≤ –≤–æ–¥—É";
        startBtn.disabled=false;
        if(!hasSplashed){
          createSplash(robinson.x,waterY);
          hasSplashed=true;
        }
        heroVisible=false;
        finishRound("lost");
        gameOverAnimTime=0;
        playSplashSound();
        vibrate(200);
        return;
      }

      const rtpFactor=getRTPFactor();

      const baseIslandProb=Math.max(
        0.0005,
        ISLAND_BASE_PROB/(1+multiplier*0.1)
      );
      const islandProb = baseIslandProb * rtpFactor;
      const birdProb  = BIRD_BASE_PROB  * (1.3 - 0.3*rtpFactor);
      const bonusProb = BONUS_BASE_PROB * rtpFactor;

      if(Math.random()<islandProb) spawnIsland();
      if(Math.random()<birdProb)  spawnBird();
      if(Math.random()<bonusProb) spawnBonus(rtpFactor);

      const dx=OBJECT_SPEED*dt;
      objects.forEach(o=>{o.x-=dx;});

      const heroBox={
        x:robinson.x-robinson.width*0.35,
        y:robinson.y-robinson.height*0.35,
        w:robinson.width*0.7,
        h:robinson.height*0.7
      };

      for(const o of objects){
        const ow=o.w*0.8,oh=o.h*0.8;
        const box={x:o.x-ow/2,y:o.y-oh/2,w:ow,h:oh};
        if(!isColliding(heroBox,box)) continue;

        if(o.type==="island"){
          state="won";
          statusEl.textContent="–ü–æ–±–µ–¥–∞! –†–æ–±–∏–Ω–∑–æ–Ω –ø—Ä–∏–∑–µ–º–ª–∏–ª—Å—è –Ω–∞ –æ—Å—Ç—Ä–æ–≤";
          winAnimTime=0;
          finishRound("won");
          playWinSound();
          vibrate([80,60,80]);
          break;
        }
        if(o.type==="bird"){
          multiplier=Math.max(1,multiplier/2);
          multiplierEl.textContent=multiplier.toFixed(2)+"x";
          statusEl.textContent="–ü—Ç–∏—Ü–∞! –í—ã–∏–≥—Ä—ã—à —É–º–µ–Ω—å—à–µ–Ω";
          gravity=Math.min(gravity+50,GRAVITY_BASE*2.5);
          robinson.vy+=50;
          o._dead=true;
          playBirdSound();
          shakeTime=0.25;
        }
        if(o.type==="bonus"){
          const val=parseInt(o.kind.slice(1));
          multiplier*=val;
          multiplierEl.textContent=multiplier.toFixed(2)+"x";
          statusEl.textContent="–ë–æ–Ω—É—Å "+o.kind+"!";
          // –ø–æ–¥—ä—ë–º –ø–æ—Å–ª–µ –±–æ–Ω—É—Å–∞ –Ω–∞ 15% –º–µ–Ω—å—à–µ (-230 -> -196)
          robinson.vy=-196;
          gravity=Math.max(GRAVITY_BASE*0.8,gravity-20);
          bonusPulse=0.25;
          addBonusParticles(o.x,o.y);
          spawnFloatingText(o.kind.toUpperCase(), robinson.x + 70, robinson.y - 40);
          o._dead=true;
          playBonusSound();
        }
      }

      objects=objects.filter(o=>o.x+o.w>-50 && !o._dead);
      cameraY=-(robinson.y-h*0.55)*0.11;
      cameraLockY=null;
    }

    function drawBackground(){
      const bg=assets.bg;
      const w=canvas.width/window.devicePixelRatio;
      const h=canvas.height/window.devicePixelRatio;
      const viewOffsetY=-h*VIEW_OFFSET_REL;
      if(bg){
        const scale=h/bg.height;
        const imgW=bg.width*scale;
        for(let x=0;x<w+imgW;x+=imgW){
          ctx.drawImage(bg,x,cameraY*0.15+viewOffsetY*0.3,imgW,h);
        }
      }else{
        ctx.fillStyle="#4cc3ff";
        ctx.fillRect(0,0,w,h);
      }
    }

    function drawWaterRegion(){
      const w=canvas.width/window.devicePixelRatio;
      const h=canvas.height/window.devicePixelRatio;
      const worldWaterY=h*WATER_LINE_REL;
      const viewOffsetY=-h*VIEW_OFFSET_REL;
      const baseY=worldWaterY+cameraY+viewOffsetY;
      const waveAmp=6,waveLen=80;

      ctx.save();
      ctx.beginPath();
      ctx.moveTo(-40,baseY+Math.sin(time*2)*2);
      for(let x=-40;x<=w+40;x+=20){
        const y=baseY+Math.sin((x/waveLen)+time*2)*waveAmp;
        ctx.lineTo(x,y);
      }
      ctx.lineTo(w+40,h);
      ctx.lineTo(-40,h);
      ctx.closePath();
      const g=ctx.createLinearGradient(0,baseY,0,h);
      g.addColorStop(0,"rgba(0,130,220,.95)");
      g.addColorStop(0.4,"rgba(0,90,180,.98)");
      g.addColorStop(1,"rgba(0,40,90,1)");
      ctx.fillStyle=g;
      ctx.fill();
      ctx.restore();
    }

    function drawSplash(){
      const h=canvas.height/window.devicePixelRatio;
      const viewOffsetY=-h*VIEW_OFFSET_REL;
      if(!splashParticles.length) return;
      ctx.save();
      for(const p of splashParticles){
        const alpha=1-p.life/p.maxLife;
        if(alpha<=0) continue;
        ctx.globalAlpha=alpha;
        ctx.fillStyle="rgba(230,245,255,1)";
        ctx.beginPath();
        ctx.arc(p.x,p.y+cameraY+viewOffsetY,p.r,0,Math.PI*2);
        ctx.fill();
      }
      ctx.restore();
    }

    function drawBonusParticles(){
      const h=canvas.height/window.devicePixelRatio;
      const viewOffsetY=-h*VIEW_OFFSET_REL;
      if(!bonusParticles.length) return;
      ctx.save();
      for(const p of bonusParticles){
        const alpha=1-p.life/p.maxLife;
        if(alpha<=0) continue;
        ctx.globalAlpha=alpha;
        ctx.fillStyle="rgba(255,220,120,1)";
        ctx.beginPath();
        ctx.arc(p.x,p.y+cameraY+viewOffsetY,2.2,0,Math.PI*2);
        ctx.fill();
      }
      ctx.restore();
    }

    // Pulz-—Å—Ç–∏–ª—å –≤—Å–ø–ª—ã–≤–∞—é—â–∏—Ö –Ω–∞–¥–ø–∏—Å–µ–π –±–æ–Ω—É—Å–æ–≤, –Ω–æ –±–µ–∑ shadowBlur
    function drawFloatingTexts(){
      const h=canvas.height/window.devicePixelRatio;
      const viewOffsetY=-h*VIEW_OFFSET_REL;
      if(!floatingTexts.length) return;
      ctx.save();
      ctx.font="bold 22px system-ui";
      ctx.textAlign="center";
      ctx.textBaseline="middle";
      for(const ft of floatingTexts){
        if(ft.alpha<=0) continue;
        ctx.globalAlpha=ft.alpha;

        const x=ft.x;
        const y=ft.y+cameraY+viewOffsetY;

        // –ê–∫–∫—É—Ä–∞—Ç–Ω—ã–π —Ç—ë–º–Ω—ã–π –∫–æ–Ω—Ç—É—Ä
        ctx.lineWidth=3;
        ctx.strokeStyle="rgba(0,0,0,0.85)";
        ctx.strokeText(ft.text,x,y);

        // –ì—Ä–∞–¥–∏–µ–Ω—Ç Pulz –±–µ–∑ —Ç–µ–Ω–µ–π
        const grad=ctx.createLinearGradient(x-40,y-10,x+40,y+10);
        grad.addColorStop(0,"#ff184e");
        grad.addColorStop(0.5,"#ff4b8a");
        grad.addColorStop(1,"#ffd1e6");
        ctx.fillStyle=grad;
        ctx.fillText(ft.text,x,y);
      }
      ctx.restore();
    }

    function drawHero(){
      if(!heroVisible) return;
      const img=assets.rob; if(!img) return;
      const h=canvas.height/window.devicePixelRatio;
      const viewOffsetY=-h*VIEW_OFFSET_REL;
      const pulse=bonusPulse>0?(bonusPulse/0.25):0;
      const tilt=Math.sin(robinsonAnimTime*6)*0.18;
      const bobY=Math.sin(robinsonAnimTime*3)*4;
      const scale=1+0.25*pulse;

      ctx.save();
      ctx.translate(robinson.x,robinson.y+bobY+cameraY+viewOffsetY);
      ctx.rotate(tilt);
      ctx.scale(scale,scale);
      ctx.drawImage(img,-robinson.width/2,-robinson.height/2,robinson.width,robinson.height);
      ctx.restore();
    }

    // Pulz-—Å—Ç–∏–ª—å –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–æ–≥–æ –≤—ã–∏–≥—Ä—ã—à–∞ –Ω–∞–¥ –†–æ–±–∏–Ω–∑–æ–Ω–æ–º, –±–µ–∑ —Ç–µ–Ω–µ–π
    function drawWinAboveHero(){
      if(!heroVisible) return;
      const h=canvas.height/window.devicePixelRatio;
      const viewOffsetY=-h*VIEW_OFFSET_REL;
      const px=robinson.x;
      const py=robinson.y+cameraY+viewOffsetY-robinson.height*0.6;
      const winNow=baseBet*multiplier;
      const text=winNow.toFixed(2)+" RUB";

      ctx.save();
      ctx.font="bold 20px system-ui";
      ctx.textAlign="center";
      ctx.textBaseline="middle";

      // –ê–∫–∫—É—Ä–∞—Ç–Ω—ã–π –∫–æ–Ω—Ç—É—Ä –±–µ–∑ shadowBlur
      ctx.lineWidth=3;
      ctx.strokeStyle="rgba(0,0,0,0.9)";
      ctx.strokeText(text,px,py);

      // –ì—Ä–∞–¥–∏–µ–Ω—Ç Pulz
      const grad=ctx.createLinearGradient(px-45,py-10,px+45,py+12);
      grad.addColorStop(0,"#ff184e");
      grad.addColorStop(0.5,"#ff4b8a");
      grad.addColorStop(1,"#ffe4f2");
      ctx.fillStyle=grad;
      ctx.fillText(text,px,py);

      ctx.restore();
    }

    function drawObjects(){
      const h=canvas.height/window.devicePixelRatio;
      const viewOffsetY=-h*VIEW_OFFSET_REL;
      for(const o of objects){
        let drawY=o.y;
        if(o.type==="bonus"||o.type==="bird"){
          const amp=o.type==="bonus"?4:6;
          const freq=o.type==="bonus"?3:2.5;
          drawY=o.y+Math.sin(time*freq+(o.phase||0))*amp;
        }
        if(o.type==="island"&&assets.island){
          ctx.drawImage(assets.island,o.x-o.w/2,o.y-o.h/2+cameraY+viewOffsetY,o.w,o.h);
        }
        if(o.type==="bonus"&&assets[o.kind]){
          ctx.drawImage(assets[o.kind],o.x-o.w/2,drawY-o.h/2+cameraY+viewOffsetY,o.w,o.h);
        }
        if(o.type==="bird"&&assets.bird){
          ctx.drawImage(assets.bird,o.x-o.w/2,drawY-o.h/2+cameraY+viewOffsetY,o.w,o.h);
        }
      }
    }

    function drawGameOverOverlay(){
      if(state!=="lost") return;
      const w=canvas.width/window.devicePixelRatio;
      const h=canvas.height/window.devicePixelRatio;
      const t=Math.min(gameOverAnimTime/0.5,1);
      const ease=1-Math.pow(1-t,3);

      ctx.save();
      ctx.globalAlpha=0.65*ease;
      ctx.fillStyle="rgba(0,0,0,1)";
      ctx.fillRect(0,0,w,h);

      const img=assets.gameover;
      ctx.globalAlpha=ease;
      if(img){
        const maxW=w*0.75,maxH=h*0.5;
        const baseScale=Math.min(maxW/img.width,maxH/img.height);
        const scale=baseScale*(0.9+0.1*ease);
        const iw=img.width*scale,ih=img.height*scale;
        const x=w/2-iw/2,y=h/2-ih/2;
        ctx.drawImage(img,x,y,iw,ih);
      }
      ctx.restore();
    }

    function drawWinOverlay(){
      if(state!=="won") return;
      const w=canvas.width/window.devicePixelRatio;
      const h=canvas.height/window.devicePixelRatio;
      const t=Math.min(winAnimTime/0.5,1);
      const ease=1-Math.pow(1-t,3);

      ctx.save();
      ctx.globalAlpha=0.55*ease;
      ctx.fillStyle="rgba(0,0,0,1)";
      ctx.fillRect(0,0,w,h);

      const img=assets.win;
      const cx=w/2,cy=h*0.32;

      ctx.globalAlpha=0.65*ease;
      const glowRadius=120;
      const grad=ctx.createRadialGradient(cx,cy,0,cx,cy,glowRadius);
      grad.addColorStop(0,"rgba(255,220,120,1)");
      grad.addColorStop(0.4,"rgba(255,180,60,0.9)");
      grad.addColorStop(1,"rgba(0,0,0,0)");
      ctx.fillStyle=grad;
      ctx.beginPath();
      ctx.arc(cx,cy,glowRadius,0,Math.PI*2);
      ctx.fill();

      ctx.globalAlpha=0.9*ease;
      const sparkleCount=10;
      for(let i=0;i<sparkleCount;i++){
        const angle=time*1.5+(i*(Math.PI*2/sparkleCount));
        const baseR=70;
        const wobble=Math.sin(time*3+i)*8;
        const r=baseR+wobble;
        const x=cx+Math.cos(angle)*r;
        const y=cy+Math.sin(angle)*r;
        const size=3+Math.sin(time*4+i)*1.2;

        ctx.save();
        ctx.translate(x,y);
        ctx.rotate(angle*2);
        ctx.beginPath();
        ctx.moveTo(-size,0);ctx.lineTo(size,0);
        ctx.moveTo(0,-size);ctx.lineTo(0,size);
        ctx.strokeStyle="rgba(255,245,200,1)";
        ctx.lineWidth=1.2;
        ctx.stroke();
        ctx.restore();
      }

      ctx.globalAlpha=ease;
      if(img){
        const maxW=w*0.75,maxH=h*0.5;
        const baseScale=Math.min(maxW/img.width,maxH/img.height);
        const scale=baseScale*(0.9+0.12*ease);
        const iw=img.width*scale,ih=img.height*scale;
        const x=cx-iw/2,y=cy-ih/2;
        ctx.drawImage(img,x,y,iw,ih);
      }else{
        ctx.font="bold 26px system-ui";
        ctx.textAlign="center";
        ctx.textBaseline="middle";
        ctx.strokeStyle="rgba(0,0,0,.8)";
        ctx.lineWidth=4;
        ctx.strokeText("–¢—ã –ø–æ–±–µ–¥–∏–ª!",cx,cy);
        ctx.fillStyle="#fff";
        ctx.fillText("–¢—ã –ø–æ–±–µ–¥–∏–ª!",cx,cy);
      }
      ctx.restore();
    }

    function render(){
      const now=performance.now();
      const dt=(now-lastTs)/1000;
      lastTs=now;

      update(dt);

      const w=canvas.width/window.devicePixelRatio;
      const h=canvas.height/window.devicePixelRatio;
      ctx.clearRect(0,0,w,h);

      ctx.save();
      if(shakeTime>0){
        const t=shakeTime/0.25;
        const str=6*t;
        const sx=(Math.random()*2-1)*str;
        const sy=(Math.random()*2-1)*str;
        ctx.translate(sx,sy);
      }

      drawBackground();
      drawWaterRegion();
      drawObjects();
      drawHero();
      drawWinAboveHero();
      drawBonusParticles();
      drawSplash();
      drawFloatingTexts();
      drawGameOverOverlay();
      drawWinOverlay();

      ctx.restore();
      requestAnimationFrame(render);
    }

    lastTs=performance.now();
    resetRound();
    requestAnimationFrame(render);
  </script>
</body>
</html>
