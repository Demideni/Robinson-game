<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<title>Robinson Jungle</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />

<style>
html,body{
  margin:0;
  padding:0;
  background:#000;
  overflow:hidden;
  font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,sans-serif;
}
#game{
  width:100vw;
  height:100vh;
  display:block;
  background:#000;
}

/* SPLASH */
#splash{
  position:absolute;
  inset:0;
  z-index:100;
  background:url("assets/splash_bg.png") center/cover no-repeat;
  opacity:1;
  transition:opacity .7s ease;
}
#splash.hidden{opacity:0;pointer-events:none;}

/* ВЕРХНЕЕ МИНИ-ЛОГО И МЕНЮ */
#top-bar{
  position:absolute;
  top:8px;left:8px;right:8px;
  z-index:50;
  display:flex;
  justify-content:space-between;
  align-items:center;
  pointer-events:none;
}
#profile-chip{
  pointer-events:auto;
  padding:4px 8px;
  border-radius:999px;
  background:rgba(0,0,0,.75);
  border:1px solid rgba(255,255,255,.15);
  font-size:12px;
  color:#fff;
}
#menu-btn{
  pointer-events:auto;
  width:34px;height:34px;
  border-radius:50%;
  border:none;
  background:radial-gradient(circle at 30% 20%,#ff6b6b,#8a0619);
  box-shadow:0 0 12px rgba(0,0,0,.8),0 0 10px rgba(255,40,40,.7);
  display:flex;align-items:center;justify-content:center;
  cursor:pointer;
}
#menu-btn span{
  display:block;width:16px;height:12px;position:relative;
}
#menu-btn span::before,
#menu-btn span::after,
#menu-btn span div{
  content:"";position:absolute;left:0;right:0;height:2px;
  border-radius:999px;background:#fff;
}
#menu-btn span::before{top:0;}
#menu-btn span::after{bottom:0;}
#menu-btn span div{top:50%;transform:translateY(-50%);}

/* НИЖНИЙ ДЖУНГЛЕВЫЙ БАР */
#bottom-ui{
  position:absolute;
  left:0;right:0;bottom:0;
  padding:12px 14px 16px;
  display:none;
  align-items:center;
  gap:12px;
  z-index:40;
  background:linear-gradient(
    to top,
    rgba(18,50,22,0.95),
    rgba(18,50,22,0.75),
    rgba(18,50,22,0)
  );
  backdrop-filter:blur(16px);
  border-top:4px solid rgba(42,110,55,1);
  box-shadow:
    inset 0 0 22px rgba(0,0,0,.75),
    0 0 22px rgba(0,0,0,.7);
}
#balance-panel,#bottom-bet{
  padding:6px 10px;
  background:rgba(31,89,39,0.90);
  border:2px solid rgba(63,143,75,.9);
  border-radius:14px;
  font-size:14px;
  color:#eaffea;
  text-shadow:0 0 4px rgba(0,0,0,.6);
  box-shadow:
      0 0 14px rgba(0,0,0,.6),
      inset 0 0 14px rgba(0,0,0,.35);
}
#bottom-bet{
  background:rgba(50,110,45,.85);
  border-color:rgba(97,182,92,1);
  cursor:pointer;
}
#start-round-btn{
  width:82px;height:82px;
  flex-shrink:0;
  border-radius:50%;
  border:4px solid rgba(97,182,92,1);
  background:radial-gradient(circle at 35% 20%, #66bb6a, #2e7d32);
  box-shadow:
      0 0 25px rgba(0,0,0,1),
      0 0 18px rgba(97,182,92,0.7);
  cursor:pointer;
  position:relative;
}
#start-round-btn::before{
  content:"";
  position:absolute;
  left:40%;top:50%;
  transform:translate(-50%,-50%);
  border-style:solid;
  border-width:10px 0 10px 18px;
  border-color:transparent transparent transparent #fff;
}
#start-round-btn:disabled{opacity:.5;box-shadow:none;cursor:default;}
#speed-control,#auto-toggle{
  padding:6px 10px;
  background:rgba(46,112,49,.88);
  border:2px solid rgba(88,165,92,1);
  border-radius:999px;
  font-size:12px;
  color:#e9ffef;
  font-weight:600;
  text-shadow:0 0 4px rgba(0,0,0,.6);
  cursor:pointer;
}

/* МОДАЛКИ */
.modal,.panel{
  position:absolute;
  inset:0;
  display:none;
  align-items:center;
  justify-content:center;
  background:rgba(0,0,0,.7);
  backdrop-filter:blur(10px);
  z-index:80;
}
.modal.open,.panel.open{display:flex;}
.modal-box,.panel-content{
  width:85%;
  max-width:340px;
  background:radial-gradient(circle at 0 0,#3e0314,#050309);
  border-radius:18px;
  border:1px solid rgba(255,255,255,.16);
  box-shadow:0 0 26px rgba(0,0,0,.9);
  padding:14px;
  color:#fff;
}
.modal-box h2,.panel-title{
  margin:0 0 8px;
  font-size:16px;
  text-transform:uppercase;
  letter-spacing:.06em;
}
.modal-action,.modal-close,.menu-btn{
  width:100%;
  margin-top:8px;
  padding:7px 10px;
  border-radius:999px;
  border:none;
  font-size:13px;
  cursor:pointer;
}
.modal-action{
  background:radial-gradient(circle at 30% 20%,#ff6b6b,#970217);
  color:#fff;
}
.modal-close{
  background:rgba(0,0,0,.8);
  color:#fff;
  border:1px solid rgba(255,255,255,.3);
}
.menu-btn{
  background:rgba(0,0,0,.8);
  color:#fff;
  border:1px solid rgba(255,255,255,.2);
}
label{font-size:12px;display:block;margin-top:8px;}
input,select{
  width:100%;
  margin-top:4px;
  padding:6px 8px;
  border-radius:10px;
  border:1px solid rgba(255,255,255,.3);
  background:rgba(0,0,0,.7);
  color:#fff;
  font-size:13px;
}
.error{color:#ff8b8b;font-size:12px;margin-top:6px;}

/* BIG WIN */
#bigwin-overlay{
  position:absolute;
  inset:0;
  display:none;
  align-items:center;
  justify-content:center;
  background:rgba(0,0,0,.7);
  backdrop-filter:blur(10px);
  z-index:120;
}
#bigwin-overlay.show{display:flex;}
#bigwin-box{
  width:80%;max-width:360px;
  background:radial-gradient(circle at 0 0,#502106,#050309);
  border-radius:20px;
  border:1px solid rgba(255,255,255,.25);
  box-shadow:0 0 30px rgba(0,0,0,.95);
  padding:16px;
  text-align:center;
  color:#fff;
}
#bigwin-title{
  font-size:20px;
  font-weight:800;
  letter-spacing:.15em;
  text-transform:uppercase;
  margin-bottom:6px;
}
#bigwin-mult{
  font-size:26px;
  font-weight:900;
  margin-bottom:4px;
}
#bigwin-amount{
  font-size:16px;
  margin-bottom:10px;
}

/* СТАВКИ */
.bet-grid{
  display:flex;
  flex-wrap:wrap;
  gap:6px;
  margin-top:6px;
}
.bet-option{
  flex:1 1 30%;
  text-align:center;
  padding:6px 0;
  border-radius:12px;
  border:1px solid rgba(255,255,255,.3);
  background:rgba(0,0,0,.7);
  cursor:pointer;
}
.bet-option.selected{
  background:radial-gradient(circle at 30% 20%,#ff6b6b,#970217);
  border-color:#fff;
}

/* ПРОЗРАЧНЫЙ ТЕКСТ-СТАТУС */
#status-text{
  position:absolute;
  left:50%;
  top:56px;
  transform:translateX(-50%);
  z-index:30;
  font-size:11px;
  color:#bdefff;
  text-shadow:0 0 4px rgba(0,0,0,.8);
}
</style>
</head>

<body>
<div id="splash"></div>
<canvas id="game"></canvas>

<div id="top-bar">
  <div id="profile-chip">Гость</div>
  <button id="menu-btn"><span><div></div></span></button>
</div>
<div id="status-text"></div>

<!-- Нижний джунглевый бар -->
<div id="bottom-ui">
  <div id="balance-panel">Баланс: <span id="balance-bottom">0.00</span></div>
  <div id="bottom-bet">Ставка: <span id="bet-bottom">1.00</span></div>
  <button id="start-round-btn"></button>
  <div id="speed-control">Speed: <span id="speed-value">Medium</span></div>
  <div id="auto-toggle">Auto: <span id="auto-status">Off</span></div>
</div>

<!-- МЕНЮ -->
<div id="menu-panel" class="panel">
  <div class="panel-content">
    <h2 class="panel-title">Меню</h2>
    <button id="menu-deposit" class="menu-btn">Пополнить</button>
    <button id="menu-withdraw" class="menu-btn">Вывести</button>
    <button id="menu-profile" class="menu-btn">Профиль</button>
    <button id="menu-close" class="modal-close" style="margin-top:10px;">Закрыть</button>
  </div>
</div>

<!-- ДЕПОЗИТ -->
<div id="deposit-modal" class="modal">
  <div class="modal-box">
    <h2>Пополнение</h2>
    <label>Сумма (RUB):</label>
    <input id="deposit-amount" type="number" value="50" />
    <label>Валюта:</label>
    <select id="deposit-coin">
      <option value="10">BTC</option>
      <option value="20">ETH (ERC20)</option>
      <option value="70">USDT (ERC20)</option>
      <option value="71">USDT (TRC20)</option>
    </select>
    <button id="deposit-create-btn" class="modal-action">Создать депозит</button>
    <div id="deposit-loading" style="display:none;margin-top:6px;">Создаём адрес…</div>
    <div id="deposit-result" style="display:none;margin-top:8px;">
      <div>Адрес:</div>
      <div id="deposit-address" style="font-size:11px;word-break:break-all;"></div>
      <button id="deposit-copy-address" class="modal-action" style="margin-top:6px;">Скопировать адрес</button>
      <div id="deposit-tag-block" style="display:none;margin-top:8px;">
        <div>Tag/Memo:</div>
        <div id="deposit-tag" style="font-size:11px;word-break:break-all;"></div>
        <button id="deposit-copy-tag" class="modal-action" style="margin-top:6px;">Скопировать Tag</button>
      </div>
    </div>
    <div id="deposit-error" class="error"></div>
    <button id="deposit-close-btn" class="modal-close">Закрыть</button>
  </div>
</div>

<!-- ВЫВОД -->
<div id="withdraw-modal" class="modal">
  <div class="modal-box">
    <h2>Вывод</h2>
    <div>Баланс: <span id="withdraw-current-balance">0.00</span></div>
    <label>Сумма:</label>
    <input id="withdraw-amount" type="number" />
    <label>Адрес кошелька:</label>
    <input id="withdraw-address" type="text" />
    <button id="withdraw-create-btn" class="modal-action">Создать заявку</button>
    <div id="withdraw-loading" style="display:none;margin-top:6px;">Отправляем…</div>
    <div id="withdraw-result" style="display:none;margin-top:6px;">
      <div id="withdraw-result-text"></div>
    </div>
    <div id="withdraw-error" class="error"></div>
    <button id="withdraw-close-btn" class="modal-close">Закрыть</button>
  </div>
</div>

<!-- ПРОФИЛЬ -->
<div id="profile-modal" class="modal">
  <div class="modal-box">
    <h2>Профиль</h2>
    <label>Никнейм:</label>
    <input id="profile-nickname" type="text" />
    <label>Email (необязательно):</label>
    <input id="profile-email" type="email" />
    <button id="profile-save-btn" class="modal-action">Сохранить</button>
    <div id="profile-loading" style="display:none;margin-top:6px;">Сохраняем…</div>
    <div id="profile-error" class="error"></div>
    <button id="profile-close-btn" class="modal-close">Закрыть</button>
  </div>
</div>

<!-- СТАВКА -->
<div id="bet-modal" class="modal">
  <div class="modal-box">
    <h2>Ставка</h2>
    <div class="bet-grid">
      <div class="bet-option" data-value="1">1</div>
      <div class="bet-option" data-value="2">2</div>
      <div class="bet-option" data-value="5">5</div>
      <div class="bet-option" data-value="10">10</div>
      <div class="bet-option" data-value="20">20</div>
      <div class="bet-option" data-value="50">50</div>
    </div>
    <button id="bet-save" class="modal-action">Применить</button>
    <button id="bet-close" class="modal-close">Закрыть</button>
  </div>
</div>

<!-- BIG WIN -->
<div id="bigwin-overlay">
  <div id="bigwin-box">
    <div id="bigwin-title">BIG WIN</div>
    <div id="bigwin-mult">x0</div>
    <div id="bigwin-amount">0 RUB</div>
    <button id="bigwin-close" class="modal-action">ОК</button>
  </div>
</div>

<script>
const canvas=document.getElementById("game");
const ctx=canvas.getContext("2d");
const splash=document.getElementById("splash");
const bottomUi=document.getElementById("bottom-ui");
const statusEl=document.getElementById("status-text");
const profileChip=document.getElementById("profile-chip");

const startBtn=document.getElementById("start-round-btn");
const balanceBottomEl=document.getElementById("balance-bottom");
const withdrawBalEl=document.getElementById("withdraw-current-balance");
const betBottomEl=document.getElementById("bet-bottom");

const speedControlEl=document.getElementById("speed-control");
const speedValueEl=document.getElementById("speed-value");
const autoToggleEl=document.getElementById("auto-toggle");
const autoStatusEl=document.getElementById("auto-status");

const menuBtn=document.getElementById("menu-btn");
const menuPanel=document.getElementById("menu-panel");
const menuDepositBtn=document.getElementById("menu-deposit");
const menuWithdrawBtn=document.getElementById("menu-withdraw");
const menuProfileBtn=document.getElementById("menu-profile");
const menuCloseBtn=document.getElementById("menu-close");

const depositModal=document.getElementById("deposit-modal");
const depositAmountInput=document.getElementById("deposit-amount");
const depositCoinSelect=document.getElementById("deposit-coin");
const depositCreateBtn=document.getElementById("deposit-create-btn");
const depositLoadingEl=document.getElementById("deposit-loading");
const depositResultEl=document.getElementById("deposit-result");
const depositAddressEl=document.getElementById("deposit-address");
const depositTagBlockEl=document.getElementById("deposit-tag-block");
const depositTagEl=document.getElementById("deposit-tag");
const depositErrorEl=document.getElementById("deposit-error");
const depositCloseBtn=document.getElementById("deposit-close-btn");
const depositCopyAddrBtn=document.getElementById("deposit-copy-address");
const depositCopyTagBtn=document.getElementById("deposit-copy-tag");

const withdrawModal=document.getElementById("withdraw-modal");
const withdrawAmountInput=document.getElementById("withdraw-amount");
const withdrawAddressInput=document.getElementById("withdraw-address");
const withdrawCreateBtn=document.getElementById("withdraw-create-btn");
const withdrawLoadingEl=document.getElementById("withdraw-loading");
const withdrawResultEl=document.getElementById("withdraw-result");
const withdrawResultTextEl=document.getElementById("withdraw-result-text");
const withdrawErrorEl=document.getElementById("withdraw-error");
const withdrawCloseBtn=document.getElementById("withdraw-close-btn");

const profileModal=document.getElementById("profile-modal");
const profileNicknameInput=document.getElementById("profile-nickname");
const profileEmailInput=document.getElementById("profile-email");
const profileSaveBtn=document.getElementById("profile-save-btn");
const profileLoadingEl=document.getElementById("profile-loading");
const profileErrorEl=document.getElementById("profile-error");
const profileCloseBtn=document.getElementById("profile-close-btn");

const betModal=document.getElementById("bet-modal");
const betSaveBtn=document.getElementById("bet-save");
const betCloseBtn=document.getElementById("bet-close");
const betOptions=Array.from(document.querySelectorAll(".bet-option"));

const bigwinOverlay=document.getElementById("bigwin-overlay");
const bigwinTitleEl=document.getElementById("bigwin-title");
const bigwinMultEl=document.getElementById("bigwin-mult");
const bigwinAmountEl=document.getElementById("bigwin-amount");
const bigwinCloseBtn=document.getElementById("bigwin-close");

const API_BASE="https://robinson-bet-api.onrender.com";

let playerId=null;
let currentRoundId=null;
let userBalance=100;
let baseBet=1;
let autoPlay=false;

let canvasW=0,canvasH=0;
function resizeCanvas(){
  const r=canvas.getBoundingClientRect();
  canvas.width=r.width*window.devicePixelRatio;
  canvas.height=r.height*window.devicePixelRatio;
  ctx.setTransform(window.devicePixelRatio,0,0,window.devicePixelRatio,0,0);
  canvasW=canvas.width/window.devicePixelRatio;
  canvasH=canvas.height/window.devicePixelRatio;
}
window.addEventListener("resize",resizeCanvas);
resizeCanvas();

function updateBalanceUI(){
  balanceBottomEl.textContent=userBalance.toFixed(2);
  withdrawBalEl.textContent=userBalance.toFixed(2);
}

const ASSETS={
  bg:"assets/bg_ocean.png",
  rob:"assets/robinson.png",
  island:"assets/island_long.png",
  bird:"assets/bird_spritesheet.png",
  x2:"assets/bonus_x2.png",
  x3:"assets/bonus_x3.png",
  x5:"assets/bonus_x5.png",
  x10:"assets/bonus_x10.png",
  x20:"assets/bonus_x20.png",
  x50:"assets/bonus_x50.png",
  x100:"assets/bonus_x100.png",
  gameover:"assets/game_over.png",
  win:"assets/win.png"
};
const assets={};
let allLoaded=false;

function loadImage(src){
  return new Promise((res,rej)=>{
    const img=new Image();
    img.src=src;
    img.onload=()=>res(img);
    img.onerror=()=>res(null);
  });
}
(async function preload(){
  for(const [k,src] of Object.entries(ASSETS)){
    assets[k]=await loadImage(src);
  }
  allLoaded=true;
  statusEl.textContent="Готово";
  setTimeout(()=>{if(splash){splash.classList.add("hidden");}},4000);
  setTimeout(()=>{bottomUi.style.display="flex";},4200);
  initProfile();
})();

async function initProfile(){
  try{
    const res=await fetch(API_BASE+"/api/session");
    const data=await res.json();
    playerId=data.playerId || "demo-player";
    userBalance=Number(data.balance ?? 100) || 100;
    if(data.nickname) profileChip.textContent=data.nickname;
    updateBalanceUI();
  }catch(e){
    playerId="demo-player";
    userBalance=100;
    updateBalanceUI();
    statusEl.textContent="Демо режим";
  }
}

function openModal(el){el.classList.add("open");}
function closeModal(el){el.classList.remove("open");}

menuBtn.onclick=()=>menuPanel.classList.add("open");
menuCloseBtn.onclick=()=>menuPanel.classList.remove("open");
menuPanel.addEventListener("click",e=>{if(e.target===menuPanel)menuPanel.classList.remove("open");});

menuDepositBtn.onclick=()=>{
  menuPanel.classList.remove("open");
  depositErrorEl.textContent="";
  depositLoadingEl.style.display="none";
  depositResultEl.style.display="none";
  openModal(depositModal);
};
menuWithdrawBtn.onclick=()=>{
  menuPanel.classList.remove("open");
  withdrawErrorEl.textContent="";
  withdrawLoadingEl.style.display="none";
  withdrawResultEl.style.display="none";
  withdrawAmountInput.value="";
  withdrawAddressInput.value="";
  openModal(withdrawModal);
};
menuProfileBtn.onclick=()=>{
  menuPanel.classList.remove("open");
  profileErrorEl.textContent="";
  profileLoadingEl.style.display="none";
  openModal(profileModal);
};

depositCloseBtn.onclick=()=>closeModal(depositModal);
withdrawCloseBtn.onclick=()=>closeModal(withdrawModal);
profileCloseBtn.onclick=()=>closeModal(profileModal);
depositModal.addEventListener("click",e=>{if(e.target===depositModal)closeModal(depositModal);});
withdrawModal.addEventListener("click",e=>{if(e.target===withdrawModal)closeModal(withdrawModal);});
profileModal.addEventListener("click",e=>{if(e.target===profileModal)closeModal(profileModal);});
betModal.addEventListener("click",e=>{if(e.target===betModal)closeModal(betModal);});

async function createDeposit(){
  try{
    depositErrorEl.textContent="";
    depositResultEl.style.display="none";
    depositLoadingEl.style.display="block";
    const amount=Number(depositAmountInput.value||0);
    const paymentId=Number(depositCoinSelect.value);
    if(!amount||amount<=0){
      depositLoadingEl.style.display="none";
      depositErrorEl.textContent="Введите сумму";
      return;
    }
    const res=await fetch(API_BASE+"/api/deposit/create",{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({userId:playerId,amountFiat:amount,paymentId})
    });
    const data=await res.json();
    depositLoadingEl.style.display="none";
    if(!res.ok||data.error){
      depositErrorEl.textContent=data.error||"Ошибка PassimPay";
      return;
    }
    depositAddressEl.textContent=data.address||"";
    depositResultEl.style.display="block";
    if(data.destinationTag){
      depositTagEl.textContent=data.destinationTag;
      depositTagBlockEl.style.display="block";
    }else{
      depositTagBlockEl.style.display="none";
    }
  }catch(e){
    depositLoadingEl.style.display="none";
    depositErrorEl.textContent="Ошибка";
  }
}
depositCreateBtn.onclick=()=>createDeposit();

function copyText(text){
  if(navigator.clipboard) navigator.clipboard.writeText(text);
}
depositCopyAddrBtn.onclick=()=>copyText(depositAddressEl.textContent.trim());
depositCopyTagBtn.onclick=()=>copyText(depositTagEl.textContent.trim());

function createWithdraw(){
  withdrawErrorEl.textContent="";
  withdrawResultEl.style.display="none";
  const amount=Number((withdrawAmountInput.value||"").replace(",","."));
  const addr=withdrawAddressInput.value.trim();
  if(!amount||amount<=0){
    withdrawErrorEl.textContent="Введите сумму";
    return;
  }
  if(amount>userBalance){
    withdrawErrorEl.textContent="Недостаточно средств";
    return;
  }
  if(!addr){
    withdrawErrorEl.textContent="Введите адрес";
    return;
  }
  withdrawLoadingEl.style.display="block";
  setTimeout(()=>{
    withdrawLoadingEl.style.display="none";
    userBalance-=amount;
    if(userBalance<0) userBalance=0;
    updateBalanceUI();
    withdrawResultTextEl.textContent="Заявка на вывод создана.";
    withdrawResultEl.style.display="block";
  },600);
}
withdrawCreateBtn.onclick=()=>createWithdraw();

async function saveProfile(){
  try{
    profileErrorEl.textContent="";
    profileLoadingEl.style.display="block";
    const nickname=profileNicknameInput.value.trim();
    const email=profileEmailInput.value.trim();
    if(!nickname){
      profileLoadingEl.style.display="none";
      profileErrorEl.textContent="Введите ник";
      return;
    }
    const res=await fetch(API_BASE+"/api/profile/register",{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({playerId,nickname,email})
    });
    const data=await res.json();
    profileLoadingEl.style.display="none";
    if(!res.ok||data.error){
      profileErrorEl.textContent=data.error||"Ошибка";
      return;
    }
    profileChip.textContent=data.nickname||nickname;
    closeModal(profileModal);
  }catch(e){
    profileLoadingEl.style.display="none";
    profileErrorEl.textContent="Ошибка сети";
  }
}
profileSaveBtn.onclick=()=>saveProfile();

betBottomEl.textContent=baseBet.toFixed(2);
function openBetModal(){
  let closest=null,minDiff=Infinity;
  betOptions.forEach(o=>{
    const v=Number(o.dataset.value);
    const d=Math.abs(v-baseBet);
    o.classList.remove("selected");
    if(d<minDiff){minDiff=d;closest=o;}
  });
  if(closest) closest.classList.add("selected");
  openModal(betModal);
}
document.getElementById("bottom-bet").onclick=openBetModal;
betCloseBtn.onclick=()=>closeModal(betModal);
betSaveBtn.onclick=()=>{
  const sel=betOptions.find(o=>o.classList.contains("selected"));
  if(sel){
    baseBet=Number(sel.dataset.value)||1;
    betBottomEl.textContent=baseBet.toFixed(2);
  }
  closeModal(betModal);
};

const SPEEDS=[
  {name:"Slow",spd:0.8,grav:0.9},
  {name:"Medium",spd:1.0,grav:1.0},
  {name:"Fast",spd:1.3,grav:1.15},
  {name:"Turbo",spd:1.7,grav:1.3}
];
let speedIndex=1;
function updateSpeedUI(){
  speedValueEl.textContent=SPEEDS[speedIndex].name;
}
updateSpeedUI();
speedControlEl.onclick=()=>{
  speedIndex=(speedIndex+1)%SPEEDS.length;
  updateSpeedUI();
};

autoToggleEl.onclick=()=>{
  autoPlay=!autoPlay;
  autoStatusEl.textContent=autoPlay?"On":"Off";
};

/* BIG WIN */
function showBigWin(winAmount,mult){
  let title="BIG WIN";
  if(mult>=500) title="EPIC WIN";
  else if(mult>=250) title="ULTRA WIN";
  else if(mult>=100) title="SUPER WIN";
  else if(mult>=50) title="MEGA WIN";
  bigwinTitleEl.textContent=title;
  bigwinMultEl.textContent="x"+mult.toFixed(0);
  bigwinAmountEl.textContent=winAmount.toFixed(2)+" RUB";
  bigwinOverlay.classList.add("show");
}
function hideBigWin(){bigwinOverlay.classList.remove("show");}
bigwinCloseBtn.onclick=hideBigWin;
bigwinOverlay.addEventListener("click",e=>{if(e.target===bigwinOverlay)hideBigWin();});

/* GAME LOGIC */
const HERO_X_REL=0.25;
const WATER_LINE_REL=0.80;
const GRAVITY_BASE=70;
const OBJECT_SPEED_BASE=460;

let state="idle"; // idle|flying|lost|won|skid
let hero={x:0,y:0,vy:0,w:60,h:60};
let objects=[]; // {type:"island"/"bird"/"bonus"}
let mainIsland=null;
let time=0,lastTs=performance.now();
let gravity=GRAVITY_BASE;

let splashParticles=[];
let bonusParticles=[];
let floatingTexts=[];
let heroVisible=true;
let gameOverAnim=0,winAnim=0,skidTime=0,skidDuration=0.8;
let skidEndToWater=false;
let cameraY=0;

let multiplier=1;
let totalBet=0,totalPayout=0;

function resetRound(){
  heroVisible=true;
  state="idle";
  time=0;
  gameOverAnim=0;
  winAnim=0;
  skidTime=0;
  splashParticles=[];
  bonusParticles=[];
  floatingTexts=[];
  gravity=GRAVITY_BASE*SPEEDS[speedIndex].grav;
  const w=canvasW,h=canvasH;
  hero.x=w*HERO_X_REL;
  hero.y=h*0.45;
  hero.vy=-170;
  hero.w=60;hero.h=60;
  cameraY=0;
  objects=[];
  const waterY=h*WATER_LINE_REL;
  mainIsland={
    type:"island",
    x:w*0.95,
    y:waterY-20,
    w:320*1.35,
    h:90*1.35
  };
  objects.push(mainIsland);
  // немного стартовых бонусов
  const bonusKinds=["x2","x3","x5","x2","x10"];
  const baseX=w*0.55;
  const spacing=150;
  bonusKinds.forEach((kind,i)=>{
    objects.push({
      type:"bonus",
      kind,
      x:baseX+i*spacing,
      y:hero.y+(Math.random()*80-40),
      w:40,h:40
    });
  });
  multiplier=1;
}

function spawnBird(){
  const w=canvasW,h=canvasH;
  const size=55;
  const y=h*0.25+Math.random()*(h*0.4);
  const x=w+size;
  objects.push({type:"bird",x,y,w:size,h:size});
}
const BONUS_POOL=["x2","x2","x3","x3","x5","x10","x20"];
function spawnBonus(){
  const w=canvasW,h=canvasH;
  const size=42;
  const y=h*0.25+Math.random()*(h*0.4);
  const x=w+size;
  const kind=BONUS_POOL[Math.floor(Math.random()*BONUS_POOL.length)];
  objects.push({type:"bonus",kind,x,y,w:size,h:size});
}

function isColliding(a,b){
  return !(a.x+a.w<b.x || a.x>b.x+b.w || a.y+a.h<b.y || a.y>b.y+b.h);
}

function createSplash(x,waterY){
  for(let i=0;i<20;i++){
    const ang=Math.random()*Math.PI-Math.PI/2;
    const sp=180+Math.random()*140;
    splashParticles.push({
      x,y:waterY,
      vx:Math.cos(ang)*sp,
      vy:Math.sin(ang)*sp*0.8,
      life:0,maxLife:0.7,r:2+Math.random()*2
    });
  }
}
function addBonusParticles(x,y){
  for(let i=0;i<18;i++){
    const ang=Math.random()*Math.PI*2;
    const sp=70+Math.random()*80;
    bonusParticles.push({
      x,y,
      vx:Math.cos(ang)*sp,
      vy:Math.sin(ang)*sp,
      life:0,maxLife:0.6
    });
  }
}
function spawnFloatingText(text,x,y){
  floatingTexts.push({text,x,y,life:0,maxLife:1.0,vy:-40});
}

async function startRound(){
  if(!allLoaded) return;
  if(state==="flying") return;
  if(userBalance<baseBet){
    statusEl.textContent="Недостаточно баланса";
    return;
  }
  try{
    const res=await fetch(API_BASE+"/api/bet/start",{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({playerId,bet:baseBet})
    });
    const data=await res.json();
    if(!res.ok||data.error){
      statusEl.textContent=data.error||"Ошибка ставки";
      return;
    }
    currentRoundId=data.roundId||null;
    if(typeof data.balance==="number"){
      userBalance=data.balance;
      updateBalanceUI();
    }
  }catch(e){
    // оффлайн: локальное списание
    userBalance-=baseBet;
    updateBalanceUI();
  }
  totalBet+=baseBet;
  resetRound();
  state="flying";
  startBtn.disabled=true;
  statusEl.textContent="Полет!";
}

async function finishRound(result){
  let winAmount=0;
  try{
    if(playerId && currentRoundId){
      const res=await fetch(API_BASE+"/api/bet/finish",{
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify({playerId,roundId:currentRoundId,result,multiplier})
      });
      const data=await res.json();
      if(res.ok){
        if(typeof data.balance==="number"){
          userBalance=data.balance;
          updateBalanceUI();
        }
        winAmount=Number(data.win||0);
      }
    }
  }catch(e){}
  currentRoundId=null;
  if(result==="won"){
    totalPayout+=winAmount;
    if(multiplier>=25) showBigWin(winAmount,multiplier);
  }
  startBtn.disabled=false;
}

startBtn.onclick=()=>{if(state!=="flying")startRound();};

function update(dt){
  time+=dt;
  const w=canvasW,h=canvasH;
  const waterY=h*WATER_LINE_REL;

  // эффекты
  splashParticles.forEach(p=>{
    p.x+=p.vx*dt;
    p.y+=p.vy*dt;
    p.vy+=350*dt;
    p.life+=dt;
  });
  splashParticles=splashParticles.filter(p=>p.life<p.maxLife);
  bonusParticles.forEach(p=>{
    p.x+=p.vx*dt;
    p.y+=p.vy*dt;
    p.vx*=0.98;p.vy*=0.98;
    p.life+=dt;
  });
  bonusParticles=bonusParticles.filter(p=>p.life<p.maxLife);
  floatingTexts.forEach(ft=>{
    ft.life+=dt;
    ft.y+=ft.vy*dt;
  });
  floatingTexts=floatingTexts.filter(ft=>ft.life<ft.maxLife);

  if(state==="lost"){
    gameOverAnim+=dt;
    return;
  }
  if(state==="won"){
    winAnim+=dt;
    return;
  }
  if(state==="skid"){
    skidTime+=dt;
    const t=Math.min(skidTime/skidDuration,1);
    if(skidEndToWater){
      hero.y+=((waterY-hero.h*0.3)-hero.y)*t*dt*4;
      if(t>=1){
        state="lost";
        heroVisible=false;
        createSplash(hero.x,waterY);
        finishRound("lost");
      }
    }else{
      // остановился на острове (не двигаем особо)
    }
    return;
  }
  if(state!=="flying") return;

  const spd=OBJECT_SPEED_BASE*SPEEDS[speedIndex].spd;
  hero.vy+=gravity*0.62*dt;
  hero.y+=hero.vy*dt;

  const topLimit=h*0.18;
  if(hero.y<topLimit){
    hero.y=topLimit;
    if(hero.vy<0) hero.vy=0;
  }

  const dx=spd*dt;
  objects.forEach(o=>{o.x-=dx;});

  if(Math.random()<0.6*dt) spawnBird();
  if(Math.random()<0.8*dt) spawnBonus();

  const heroBox={x:hero.x-hero.w*0.4,y:hero.y-hero.h*0.4,w:hero.w*0.8,h:hero.h*0.8};

  for(const o of objects){
    if(o.type==="bird"){
      const box={x:o.x-o.w/2,y:o.y-o.h/2,w:o.w,h:o.h};
      if(isColliding(heroBox,box)){
        multiplier=Math.max(multiplier*0.25,0.25);
        hero.vy+=60;
        o._dead=true;
      }
    }
    if(o.type==="bonus"){
      const box={x:o.x-o.w/2,y:o.y-o.h/2,w:o.w,h:o.h};
      if(isColliding(heroBox,box)){
        const val=parseInt(o.kind.slice(1))||2;
        multiplier*=val;
        spawnFloatingText(o.kind,hero.x+60,hero.y-40);
        addBonusParticles(o.x,o.y);
        o._dead=true;
      }
    }
  }
  objects=objects.filter(o=>!o._dead && o.x+o.w>-80);

  // столкновение с островом
  if(mainIsland){
    const islandTop=mainIsland.y-mainIsland.h/2;
    const islandBottom=mainIsland.y+mainIsland.h/2;
    const islandLeft=mainIsland.x-mainIsland.w/2;
    const islandRight=mainIsland.x+mainIsland.w/2;
    const heroFull={x:hero.x-hero.w/2,y:hero.y-hero.h/2,w:hero.w,h:hero.h};
    const islandBox={x:islandLeft,y:islandTop,w:mainIsland.w,h:mainIsland.h};
    const coll=isColliding(heroFull,islandBox);

    if(coll){
      const r=Math.random();
      // 75% – приземлился, проскользил и упал
      if(r<0.75){
        state="skid";
        skidTime=0;
        skidDuration=0.9;
        skidEndToWater=true;
        statusEl.textContent="Почти удержался на острове!";
      }
      // 15% – остановился на острове
      else if(r<0.90){
        state="won";
        winAnim=0;
        hero.y=islandTop-hero.h*0.5;
        statusEl.textContent="Победа! Робинзон на острове";
        finishRound("won");
      }
      // 10% – жёсткий промах/падение
      else{
        state="lost";
        heroVisible=false;
        createSplash(hero.x,waterY);
        statusEl.textContent="Робинзон упал в воду";
        finishRound("lost");
      }
      return;
    }
  }

  // если прошёл остров и упал в воду
  if(hero.y+hero.h*0.5>=waterY){
    state="lost";
    heroVisible=false;
    createSplash(hero.x,waterY);
    statusEl.textContent="Робинзон упал в воду";
    finishRound("lost");
  }
}

function drawBackground(){
  const w=canvasW,h=canvasH;
  if(assets.bg){
    const img=assets.bg;
    const scale=h/img.height;
    const iw=img.width*scale;
    const x0=-((time*30)%iw);
    for(let x=x0;x<w+iw;x+=iw){
      ctx.drawImage(img,x,0,iw,h);
    }
  }else{
    const g=ctx.createLinearGradient(0,0,0,h);
    g.addColorStop(0,"#4ac1ff");
    g.addColorStop(1,"#015287");
    ctx.fillStyle=g;
    ctx.fillRect(0,0,w,h);
  }
}

function drawWater(){
  const w=canvasW,h=canvasH;
  const waterY=h*WATER_LINE_REL;
  ctx.save();
  const g=ctx.createLinearGradient(0,waterY,0,h);
  g.addColorStop(0,"rgba(0,150,210,.98)");
  g.addColorStop(1,"rgba(0,45,100,1)");
  ctx.fillStyle=g;
  ctx.fillRect(0,waterY,w,h-waterY);
  ctx.restore();
}

function drawObjects(){
  const h=canvasH;
  for(const o of objects){
    if(o.type==="island" && assets.island){
      ctx.drawImage(assets.island,o.x-o.w/2,o.y-o.h/2,o.w,o.h);
    }
    if(o.type==="bonus" && assets[o.kind]){
      ctx.drawImage(assets[o.kind],o.x-o.w/2,o.y-o.h/2,o.w,o.h);
    }
    if(o.type==="bird" && assets.bird){
      ctx.drawImage(assets.bird,o.x-o.w/2,o.y-o.h/2,o.w,o.h);
    }
  }
}

function drawHero(){
  if(!heroVisible) return;
  const img=assets.rob;
  if(!img) return;
  ctx.save();
  ctx.translate(hero.x,hero.y);
  ctx.drawImage(img,-hero.w/2,-hero.h/2,hero.w,hero.h);
  ctx.restore();
}

function drawEffects(){
  splashParticles.forEach(p=>{
    const a=1-p.life/p.maxLife;
    if(a<=0)return;
    ctx.globalAlpha=a;
    ctx.fillStyle="#e5f7ff";
    ctx.beginPath();
    ctx.arc(p.x,p.y,p.r,0,Math.PI*2);
    ctx.fill();
    ctx.globalAlpha=1;
  });
  bonusParticles.forEach(p=>{
    const a=1-p.life/p.maxLife;
    if(a<=0)return;
    ctx.globalAlpha=a;
    ctx.fillStyle="#ffe48a";
    ctx.beginPath();
    ctx.arc(p.x,p.y,2,0,Math.PI*2);
    ctx.fill();
    ctx.globalAlpha=1;
  });
  ctx.save();
  ctx.font="bold 18px system-ui";
  ctx.textAlign="center";
  ctx.textBaseline="middle";
  floatingTexts.forEach(ft=>{
    const a=1-ft.life/ft.maxLife;
    if(a<=0)return;
    ctx.globalAlpha=a;
    ctx.strokeStyle="rgba(0,0,0,.9)";
    ctx.lineWidth=3;
    ctx.strokeText(ft.text,ft.x,ft.y);
    ctx.fillStyle="#fff";
    ctx.fillText(ft.text,ft.x,ft.y);
    ctx.globalAlpha=1;
  });
  ctx.restore();
}

function drawHeroWinText(){
  if(!heroVisible) return;
  const pot=baseBet*multiplier;
  const text=pot.toFixed(2)+" RUB";
  ctx.save();
  ctx.font="bold 16px system-ui";
  ctx.textAlign="center";
  ctx.textBaseline="middle";
  ctx.strokeStyle="rgba(0,0,0,.9)";
  ctx.lineWidth=3;
  ctx.strokeText(text,hero.x,hero.y-50);
  ctx.fillStyle="#fff";
  ctx.fillText(text,hero.x,hero.y-50);
  ctx.restore();
}

function drawGameOverOverlay(){
  if(state!=="lost") return;
  const w=canvasW,h=canvasH;
  const t=Math.min(gameOverAnim/0.5,1);
  ctx.save();
  ctx.globalAlpha=0.6*t;
  ctx.fillStyle="#000";
  ctx.fillRect(0,0,w,h);
  ctx.globalAlpha=1*t;
  const img=assets.gameover;
  if(img){
    const maxW=w*0.8,maxH=h*0.4;
    const s=Math.min(maxW/img.width,maxH/img.height);
    const iw=img.width*s,ih=img.height*s;
    ctx.drawImage(img,w/2-iw/2,h/2-ih/2,iw,ih);
  }else{
    ctx.font="bold 22px system-ui";
    ctx.textAlign="center";ctx.textBaseline="middle";
    ctx.fillStyle="#fff";
    ctx.fillText("Робинзон упал в воду",w/2,h/2);
  }
  ctx.restore();
}

function drawWinOverlay(){
  if(state!=="won") return;
  const w=canvasW,h=canvasH;
  const t=Math.min(winAnim/0.5,1);
  ctx.save();
  ctx.globalAlpha=0.5*t;
  ctx.fillStyle="#000";
  ctx.fillRect(0,0,w,h);
  ctx.globalAlpha=1*t;
  const img=assets.win;
  if(img){
    const maxW=w*0.8,maxH=h*0.4;
    const s=Math.min(maxW/img.width,maxH/img.height);
    const iw=img.width*s,ih=img.height*s;
    ctx.drawImage(img,w/2-iw/2,h/2-ih/2,iw,ih);
  }else{
    ctx.font="bold 24px system-ui";
    ctx.textAlign="center";ctx.textBaseline="middle";
    ctx.fillStyle="#fff";
    ctx.fillText("Ты победил!",w/2,h/2);
  }
  ctx.restore();
}

function loop(){
  const now=performance.now();
  const dt=(now-lastTs)/1000;
  lastTs=now;
  update(dt);
  ctx.clearRect(0,0,canvasW,canvasH);
  drawBackground();
  drawWater();
  drawObjects();
  drawHero();
  drawHeroWinText();
  drawEffects();
  drawGameOverOverlay();
  drawWinOverlay();
  requestAnimationFrame(loop);
}
resetRound();
requestAnimationFrame(loop);
</script>
</body>
</html>
